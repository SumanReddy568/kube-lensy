<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KubeLensy - Internal System Debugger</title>
    <style>
        :root {
            --bg: #0d1117;
            --header: #161b22;
            --text: #c9d1d9;
            --primary: #58a6ff;
            --error: #f85149;
            --border: #30363d;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas, Liberation Mono, monospace;
            height: 100-vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background-color: var(--header);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #8b949e;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #238636;
            box-shadow: 0 0 8px rgba(35, 134, 54, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.5;
            }
        }

        #terminal {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 13px;
            line-height: 1.5;
            background-color: var(--bg);
        }

        .line {
            display: flex;
            gap: 16px;
            padding: 2px 0;
        }

        .ln {
            color: #484f58;
            user-select: none;
            width: 40px;
            text-align: right;
            flex-shrink: 0;
        }

        .err {
            color: var(--error);
        }

        .sys {
            color: var(--primary);
            font-weight: bold;
            border-left: 2px solid var(--primary);
            padding-left: 8px;
            margin: 8px 0;
        }

        .controls {
            display: flex;
            gap: 12px;
        }

        button {
            background: var(--border);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover {
            background: #3c444d;
        }
    </style>
</head>

<body>
    <header>
        <h1>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" style="color: var(--primary)">
                <polyline points="4 17 10 11 4 5"></polyline>
                <line x1="12" y1="19" x2="20" y2="19"></line>
            </svg>
            KubeLensy System Debugger
        </h1>
        <div class="controls">
            <button onclick="window.location.href='/'">Go to App</button>
            <button onclick="clearLogs()">Clear Screen</button>
            <div class="status">
                <div class="dot"></div>
                LIVE SYSTEM FEED
            </div>
        </div>
    </header>
    <pre id="terminal"></pre>

    <script>
        const terminal = document.getElementById('terminal');
        let lineCount = 0;

        function addLine(text) {
            lineCount++;
            const div = document.createElement('div');
            div.className = 'line';

            const isError = text.includes('[STDERR]') || text.includes('error') || text.includes('Error');
            const isSession = text.includes('--- Session Started ---');

            if (isSession) div.classList.add('sys');

            div.innerHTML = `
                <span class="ln">${lineCount}</span>
                <span class="${isError ? 'err' : ''}">${escapeHtml(text)}</span>
            `;

            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;

            if (terminal.children.length > 5000) {
                terminal.removeChild(terminal.firstChild);
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function clearLogs() {
            terminal.innerHTML = '';
            lineCount = 0;
            addLine('--- Screen Cleared ---');
        }

        // Load initial logs
        fetch('/api/debug/logs')
            .then(res => res.text())
            .then(text => {
                const lines = text.split('\n');
                lines.forEach(line => {
                    if (line.trim()) addLine(line);
                });
            })
            .catch(err => addLine('Error loading initial logs: ' + err.message));

        // Start streaming
        const eventSource = new EventSource('/api/debug/logs/stream');
        eventSource.onmessage = (event) => {
            addLine(event.data);
        };
        eventSource.onerror = () => {
            addLine('DEBUG: Stream connection lost. Retrying...');
        };
    </script>
</body>

</html>